name: Generate and Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # required for sitemap gen

      - name: Setup Node.js
        uses: actions/setup-node@v4

      # ---- Generate banners.json ----
      - name: Generate banners.json
        run: node .github/scripts/make-banner-manifest.js

      # ---- Optimize images (WebP + compress originals) ----
      - name: Optimize images
        uses: calibreapp/image-actions@v1
        with:
          compressOnly: false
          ignoreJpg: false
          ignorePng: false

      - name: Minify GitHub Pages
        uses: Massi-X/minify-gh-pages-action@v2
        with:
          source: ./
          compress: js,css,html
          js_options: '{"mangle": false}'
          html_options: '{"caseSensitive": true}'

      - name: Spellcheck HTML Files
        uses: gevhaz/Word-Warden@v1.0.0
        with:
          files: /*.html
          dictionary: /docs/terminoligy_aspell.txt

      - name: Generate the sitemap
        uses: cicirello/generate-sitemap@v1
        with:
          base-url-path: https://wiki.koyot.digital
          exclude-paths: /NavGrid.html

      # ---- Commit any changes ----
      - name: Commit and push changes
        run: |
          git config user.name "Autotron"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet || git commit -m "Auto optimize assets"
          git push

      # ---- GitHub Pages upload ----
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
